<?php 
session_start();
$error = '';
$info = '';

// Importar PHPMailer sin Composer
require 'PHPMailer/Exception.php';
require 'PHPMailer/PHPMailer.php';
require 'PHPMailer/SMTP.php';

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

function enviarRecuperacion($correo, $usuario, $password) {
    $mail = new PHPMailer(true);
    try {
        // Configuración del servidor SMTP (Gmail)
        $mail->isSMTP();
        $mail->Host = 'smtp.gmail.com';
        $mail->SMTPAuth = true;
        $mail->Username = 'TU_CORREO@gmail.com'; // tu correo Gmail
        $mail->Password = 'TU_CONTRASEÑA_DE_APLICACION'; // clave de aplicación de Gmail
        $mail->SMTPSecure = 'tls';
        $mail->Port = 587;

        // Remitente y destinatario
        $mail->setFrom('TU_CORREO@gmail.com', 'Sistema de Recuperación');
        $mail->addAddress($correo);

        // Contenido
        $mail->isHTML(true);
        $mail->Subject = 'Recuperación de credenciales';
        $mail->Body = "<p>Hola,</p>
                       <p>Tu usuario es: <b>$usuario</b></p>
                       <p>Tu nueva clave temporal es: <b>$password</b></p>
                       <p>Por favor cámbiala después de ingresar.</p>";

        $mail->send();
        return true;
    } catch (Exception $e) {
        return false;
    }
}

if ($_SERVER["REQUEST_METHOD"] === "POST") {
    if (isset($_POST['ingresar'])) {
        $usuario = trim($_POST['usuario']);
        $clave = trim($_POST['clave']);
        if (!$usuario || !$clave) {
            $error = "Usuario y clave son obligatorios.";
        } else {
            $conexion = new mysqli("localhost", "root", "", "gestion_datos");
            if ($conexion->connect_error) die("Error de conexión");
            $stmt = $conexion->prepare("SELECT contrasena, estado FROM usuario WHERE nombreu = ?");
            $stmt->bind_param("s", $usuario);
            $stmt->execute();
            $res = $stmt->get_result();
            if ($res->num_rows === 1) {
                $fila = $res->fetch_assoc();
                if ($fila['estado'] !== 'Activo') {
                    $error = "Usuario inactivo. Contacta al administrador.";
                } elseif (password_verify($clave, $fila['contrasena'])) {
                    $_SESSION['usuario'] = $usuario;
                    header("Location: menu.php");
                    exit;
                } else {
                    $error = "Clave incorrecta.";
                }
            } else {
                $error = "Usuario no encontrado.";
            }
            $stmt->close();
            $conexion->close();
        }
    } elseif (isset($_POST['recuperar'])) {
        $usuario = trim($_POST['usuario']);
        if (!$usuario) {
            $error = "Por favor ingresa tu usuario para recuperar.";
        } else {
            $conexion = new mysqli("localhost", "root", "", "gestion_datos");
            if ($conexion->connect_error) die("Error de conexión");
            
            $stmt = $conexion->prepare("SELECT correo FROM personal per 
                JOIN usuario us ON per.idpersona = us.idpersona 
                WHERE us.nombreu = ?");
            $stmt->bind_param("s", $usuario);
            $stmt->execute();
            $res = $stmt->get_result();

            if ($res->num_rows === 1) {
                $fila = $res->fetch_assoc();
                $correo = $fila['correo'];

                // Generar clave temporal aleatoria
                $nuevaClave = substr(str_shuffle('ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789'), 0, 8);
                $hash = password_hash($nuevaClave, PASSWORD_DEFAULT);

                // Actualizar en BD
                $upd = $conexion->prepare("UPDATE usuario SET contrasena = ? WHERE nombreu = ?");
                $upd->bind_param("ss", $hash, $usuario);
                $upd->execute();
                $upd->close();

                // Enviar correo con la nueva clave
                if (enviarRecuperacion($correo, $usuario, $nuevaClave)) {
                    $info = "Se ha enviado una nueva contraseña temporal a su correo.";
                } else {
                    $error = "Error al enviar el correo.";
                }
            } else {
                $error = "El usuario no se encuentra registrado.";
            }
            $stmt->close();
            $conexion->close();
        }
    }
}
?>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iniciar Sesión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(to bottom, #87cefa, #ffffff);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .box { background:white; padding:30px; border-radius:15px; box-shadow:0 0 15px rgba(0,0,0,0.2); width:350px; }
    h2 { color:#005f99; font-weight:bold; margin-bottom:25px; text-align:center; }
    .btn-primary { background:#007acc; border:none; border-radius:25px; padding:10px 30px; }
    .btn-primary:hover { background:#005f99; }
    .btn-secondary { border-radius:25px; }
    .links a { color:#007acc; text-decoration:none; }
    .links a:hover { text-decoration:underline; }
  </style>
</head>
<body>
  <div class="box">
    <h2>Iniciar Sesión</h2>
    <?php if ($error): ?>
      <div class="alert alert-danger"><?=htmlspecialchars($error)?></div>
    <?php elseif ($info): ?>
      <div class="alert alert-success"><?=htmlspecialchars($info)?></div>
    <?php endif; ?>

    <form method="POST" onsubmit="return validar()">
      <div class="mb-3 text-start">
        <label class="form-label">Usuario</label>
        <input type="text" name="usuario" id="usuario" class="form-control" autofocus value="<?=htmlspecialchars($_POST['usuario'] ?? '')?>">
      </div>
      <div class="mb-3 text-start">
        <label class="form-label">Clave</label>
        <input type="password" name="clave" id="clave" class="form-control">
      </div>
      <div class="d-flex justify-content-between mb-3">
        <button type="submit" name="ingresar" class="btn btn-primary">Ingresar</button>
        <button type="button" onclick="limpiar()" class="btn btn-secondary">Cancelar</button>
      </div>
      <div class="d-flex justify-content-between">
        <button type="submit" name="recuperar" class="btn btn-outline-info">Recuperar</button>
        <a href="gestion_usuario.php" class="btn btn-link">Registrarse</a>
      </div>
    </form>
  </div>

<script>
function limpiar() {
  document.getElementById('usuario').value = '';
  document.getElementById('clave').value = '';
  document.getElementById('usuario').focus();
}
function validar() {
  const u = document.getElementById('usuario').value.trim();
  if (!u) { alert('Ingrese usuario'); document.getElementById('usuario').focus(); return false; }
  return true;
}
</script>

</body>
</html>
