<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  // Verificar sesión
  const usuario = localStorage.getItem("usuario");
  if (!usuario) {
    alert("¡Ooops! Debes iniciar sesión primero");
    window.location.href = "index.html";
  }

  // Inicializar EmailJS
  emailjs.init("V_7XXS-cj433ImG5Q");

  const form = document.getElementById('registroForm');
  const verCitasBtn = document.getElementById("verCitas");

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
      "Nombre": form.Nombre.value,
      "Telefono": form.Telefono.value,
      "Email": form.Email.value,
      "Nombre_Mascota": form.Nombre_Mascota.value,
      "Raza": form.Raza.value,
      "Especie_Animal": form.Especie_Animal.value,
      "Fecha": form.Fecha.value,
      "Hora": form.Hora.value,
      "Mensaje": form.Mensaje.value
    };

    try {
      // Enviar a Supabase
      const response = await fetch("https://erxgjoacksfghrddptvn.supabase.co/rest/v1/citas", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyeGdqb2Fja3NmZ2hyZGRwdHZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMTA0NTksImV4cCI6MjA2ODg4NjQ1OX0.v0iv9fLe61PVduo3s2HIRFpgAIcMpUik3u82SGYmLE0",
          "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyeGdqb2Fja3NmZ2hyZGRwdHZuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMTA0NTksImV4cCI6MjA2ODg4NjQ1OX0.v0iv9fLe61PVduo3s2HIRFpgAIcMpUik3u82SGYmLE0"
        },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const err = await response.text();
        console.error("Error Supabase:", err);
        alert("Error al registrar. Verifica los datos o permisos.");
        return;
      }

      // Enviar email de confirmación
      await emailjs.send("service_ez5hhuq", "template_ih4h0k8", {
        nmascota: data.Nombre_Mascota,
        fecha: data.Fecha,
        hora: data.Hora,
        cadicionales: data.Mensaje
      });

      alert("✅ ¡Gracias! Tu cita ha sido registrada y confirmada.");
      window.location.href = "index.html";
    } catch (error) {
      console.error("Error general:", error);
      alert("Hubo un problema al procesar tu cita.");
    }
  });
</script>
